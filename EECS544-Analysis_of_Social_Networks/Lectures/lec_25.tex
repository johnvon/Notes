\lecture{25}{08 Dec. 12:30}{Perfect Matching}
We now want to solve the following questions.
\begin{problem}
Given a \href{https://en.wikipedia.org/wiki/Bipartite_graph}{bipartite graph}, can we check if there is a \hyperref[def:perfect-matching]{perfect matching}?
\end{problem}
\begin{answer}
	Yes, by \hyperref[sec:Hopcroft-Karp-algorithm]{Hopcroft-Karp algorithm}, which is an \underline{asymmetric BFS algorithm}.
\end{answer}

\begin{problem}[Market clearing prices]
Given a market, do the \hyperref[note:market-clearing-prices]{market clearing prices} exist? If they do, can we find them?
\end{problem}
\begin{answer}
	Yes. We can find it in polynomial time by Hungarian algorithm. Also, by using \hyperref[thm:VCG]{VCG principle},
	we can obtain specific \hyperref[note:market-clearing-prices]{market clearing prices}.
\end{answer}

\begin{problem}[Social welfare]
What's the connection between \hyperref[note:market-clearing-prices]{market clearing prices} and \hyperref[def:social-welfare]{social welfare}
maximizing.
\end{problem}

\section{Hopcroft-Karp Algorithm}\label{sec:Hopcroft-Karp-algorithm}
To answer the first question, we need to use \autoref{thm:Konig-Hall-maximize-theorem}. We first define buyer nodes such that
\[
	\text{Buyer nodes}\in \{\text{free}, \text{matched}, \text{exhausted}   \}
\]
and seller nodes such that
\[
	\text{Seller nodes}\in \{\text{free}, \text{matched}\},
\]
and also edges such that
\[
	\text{Edges}\in \{\text{free}, \text{matched}\}.
\]

Then the algorithm can be described as follows.

\par\todo{Make this into formal pseudo-code}
\begin{algorithm}[H]\label{algo:Hopcroft-Karp-algo}
	\DontPrintSemicolon
	\caption{Hopcroft-Karp Algorithm}
	\KwData{}
	\KwResult{}
	\SetKwFunction{TC}{TossCoin}
	\SetKwFunction{rand}{rand}
	\SetKwFunction{randW}{randWithWeight}
	\SetKwData{result}{result}
	\SetKwData{up}{unpaired}
	\SetKwData{region}{region}
	\BlankLine

\end{algorithm}

\begin{enumerate}
	\item[0.] All nodes and edges are marked as free.
	\item[1.] Initial step. Pick some matching and go through free buyers and match to free sellers they are connected to.
		After match labels of buyers, sellers and edge to matched. If any buyers is not able to be matched, let it be free for now.
	\item[2.] If after this initial step, there are no free buyers, then we're done and perfect match is obtained.
	\item[3.] Otherwise, there are some free buyers left.
		\begin{itemize}
			\item Pick one of these free buyers, connect it to all \textbf{matched} sellers that this free buyers has edges with(all edges here are free)
			\item For each \textbf{matched} sellers, go to the other side using the \textbf{matched} edges, we'll end up at matched buyers.
			\item For each \textbf{matched} buyers, use free edges to connect to the other side, which is seller.
			\item Return to the buyers side from any \textbf{matched} sellers using their \textbf{matched} edges.
		\end{itemize}
	\item[4.] Repeat until no exploration can be done.
		\begin{itemize}
			\item Matched buyer has no free edges.
			\item All new sellers are free.
		\end{itemize}
\end{enumerate}

\begin{intuition}
	It's essentially an asymmetric BFS with labels.
\end{intuition}

\begin{remark}
	We see that
	\begin{itemize}
		\item At termination, if there is a path from a \textbf{free} buyer to a \textbf{free} seller, then it has to have alternating labels. We
		      call such a path an \emph{augmenting path}, since we can augment the total size of the matching by \(1\) by altering this path.
		\item Specifically, if an augmenting path exists, then flip all the labels of the edges, and label the free buyers and sellers to matched. This
		      will increase the size of the matching by \(1\).
		\item If for a free buyer node, no augmenting paths are found, then label it as exhausted. Repeat through all free buyers nodes, until none remain.
		\item This is a polynomial time algorithm, since we will only explore every node once.
	\end{itemize}
\end{remark}

We then state a fundamental theorem about the \textbf{only} constraint when constructing a \hyperref[def:perfect-matching]{perfect matching},
without proving it.
\begin{theorem}\label{thm:lec25-1}
	If there are no exhausted buyer nodes, then we have a \hyperref[def:perfect-matching]{perfect matching}. Otherwise, if there are exhausted buyer nodes, then we
	can find some \hyperref[def:constricted-set]{constricted sets}.
\end{theorem}
\begin{note}
	In the first scenario, we will obtain it using matched edges. Also, in the second scenario, we will only obtain a maximal matching
	using the matched edges.
\end{note}

\begin{remark}
	\autoref{thm:lec25-1} essentially tells us that the only obstacle one will meet when constructing a \hyperref[def:perfect-matching]{perfect matching}
	is the existence of \hyperref[def:constricted-set]{constricted set}.
\end{remark}

\section{Market Clearing Prices}
We now come back to \hyperref[note:market-clearing-prices]{market clearing prices} problem.

\begin{problem}
Given \hyperref[def:valuation-matrix]{valuation matrix} \(V\) and price vector \(p\), is it always the case that a
\hyperref[note:market-clearing-prices]{market clearing price} exists?
\end{problem}
\begin{answer}
	Yes, and we can find it in polynomial time. (\href{https://en.wikipedia.org/wiki/Hungarian_algorithm}{Hungarian algorithm}
	do it in \(O(n^{3})\), which is strongly polynomial time)
\end{answer}

Without loss of generality, as assume that \(V_{1}>V_{2}>V_{3}\geq \ldots \geq V_{N}\). Then we easily see that if
\begin{itemize}
	\item \(p = (V_{1}, 0, \ldots , 0 )\), then a \hyperref[def:perfect-matching]{perfect matching} exists.
	      \begin{note}
		      This is essentially a \hyperref[eg:first-price-auction]{first price auction}.
	      \end{note}
	\item \(p = (V_{2}, 0, \ldots , 0 )\), then a \hyperref[def:perfect-matching]{perfect matching} exists as well.
	      \begin{note}
		      This is essentially a \hyperref[eg:second-price-auction]{second price auction}.
	      \end{note}
	      Furthermore, if
	      \begin{itemize}
		      \item \(p_{1}>V_{1}\), then no \hyperref[def:perfect-matching]{perfect matching} exists.
		      \item \(p_{1}<V_{2}\), then no \hyperref[def:perfect-matching]{perfect matching} exists as well.
	      \end{itemize}
\end{itemize}

We claim that \hyperref[note:market-clearing-prices]{market clearing prices} always exists, and will follow so-called \emph{Lattice structure}. Says if
\(p^{1}\) and \(p^{2}\) are both market clearing prices, then
\[
	\begin{split}
		p^{1}\lor p^{2} &\coloneqq \text{element-wise max}\\
		p^{1}\land p^{2} &\coloneqq \text{element-wise min}\\
	\end{split}
\]
are also \hyperref[note:market-clearing-prices]{market clearing prices}, where
\begin{itemize}
	\item Max \hyperref[note:market-clearing-prices]{market clearing price} is by taking the maximum in all components.
	\item Min \hyperref[note:market-clearing-prices]{market clearing price} is by taking the minimum in all components.
\end{itemize}


\begin{remark}
	There is a nice property for \hyperref[note:market-clearing-prices]{market clearing prices}: It's always \hyperref[def:social-welfare]{social welfare}
	maximizing, respect to the \hyperref[def:reward]{utility} of all buyers and the sum of prices (seller made).
\end{remark}

We can actually formulate the above question as a linear programming. Define \(x_{ij} \in [0, 1]\) as the part of
good \(j\) in assigned to buyer \(i\), namely we allow fractional assignment. Then we model the above question as

\begin{align*}
	V^{\ast} \coloneqq \max~ & \sum\limits_{i, j}V_{ij}x_{ij}       \\
	                         & \sum\limits_{j}x_{ij} = 1\ \forall i \\
	                         & \sum\limits_{i}x_{ij} = 1\ \forall j \\
	                         & x_{ij}\in[0, 1].
\end{align*}
\begin{intuition}
	We see that
	\begin{itemize}
		\item The first constraint says that buyer want one good.
		\item The second constraint says that seller has one good for type \(j\).
	\end{itemize}
\end{intuition}

If we further restrict the fractional assignment property, then we have the integer programming version of above, namely
\begin{align*}
	V^{\ast} \coloneqq \max~ & \sum\limits_{i, j}V_{ij}x_{ij}       \\
	                         & \sum\limits_{j}x_{ij} = 1\ \forall i \\
	                         & \sum\limits_{i}x_{ij} = 1\ \forall j \\
	                         & x_{ij}\in\{0, 1\}.
\end{align*}

\begin{remark}
	We see that
	\begin{itemize}
		\item \hyperref[def:perfect-matching]{Perfect matching} is the only possible solution.
		\item Solving the linear programming leads to an integer solution.
		\item The \hyperref[note:market-clearing-prices]{market clearing price} induced by \hyperref[def:perfect-matching]{perfect matching}
		      will achieve \(V^{\ast}\) in the integer programming, which is \hyperref[def:social-welfare]{social welfare} maximizing.
	\end{itemize}
\end{remark}

\section{Demange-Gale-Sotomayor Algorithm}
Given an \hyperref[eg:English-auction]{English auction} for multiple goods, with valuations and prices being all in integers, we can run the
so-called \hyperref[algo:Demange-Gale-Sotomayor-algorithm]{Demange-Gale-Sotomayor (DGS) algorithm} and get a set of
\hyperref[note:market-clearing-prices]{market clearing prices}.

\par\todo{Make this into formal pseudo-code}
\begin{algorithm}[H]\label{algo:Demange-Gale-Sotomayor-algorithm}
	\DontPrintSemicolon
	\caption{Demange-Gale-Sotomayor Algorithm}
	\KwData{}
	\KwResult{}
	\SetKwFunction{TC}{TossCoin}
	\SetKwFunction{rand}{rand}
	\SetKwFunction{randW}{randWithWeight}
	\SetKwData{result}{result}
	\SetKwData{up}{unpaired}
	\SetKwData{region}{region}
	\BlankLine

\end{algorithm}

\begin{enumerate}
	\item Set initial price to \(p = (0, 0, \ldots , 0 )\)
	\item At \(p\) fixed the preferred sellers bipartite graph.
	\item Check if there is a \hyperref[def:perfect-matching]{perfect matching}.(Can be done by \hyperref[sec:Hopcroft-Karp-algorithm]{Hopcroft-Karp Algorithm})
	      \begin{itemize}
		      \item If yes, then end.
		      \item Otherwise, determine a constricted set of buyers \(B\), namely find a \(B\) such that
		            \[
			            \left\vert N(B) \right\vert < \left\vert B \right\vert.
		            \]

		            Pick any non-empty subset \(S\) of \(N(B)\) and increase the price of the goods in \(S\) all by \(1\).
	      \end{itemize}
	\item \textbf{GOTO 2}.
\end{enumerate}

\begin{intuition}
	If there is more demand and less supply, then we increase the price.
\end{intuition}

\begin{remark}
	This algorithm will terminate in finite-time, further, it's actually a polynomial time algorithm.
\end{remark}

If one carefully enough for choosing \(S\), he will always terminate in the minimum \hyperref[note:market-clearing-prices]{market clearing prices}.

\section{VCG Principle}
Consider a \hyperref[eg:second-price-auction]{second price auction}. There is only \(1\) item to be sold with \(N\) buyers with valuation
\(V_{1}, V_{2}, \ldots , V_{N}\). We further let
\[
	V_{1}>V_{2}>V_{3}\geq \ldots V_{N}.
\]

In this case, we see that \hyperref[def:player]{agent} \(1\) gets the good with price \(V_{2}\). We denote the \hyperref[def:reward]{utility}
as \(\Delta\coloneqq V_{1}-V_{2}>0\).

\begin{problem}
What's the \hyperref[def:reward]{utility} of other \hyperref[def:player]{players}?
\end{problem}
\begin{answer}
	\(0\).
\end{answer}

We now conduct a thought experiment. If we remove \hyperref[def:player]{agent} \(1\) and replace him with a dummy \hyperref[def:player]{agent},
says \(\tilde{1}\), then we see that \hyperref[def:player]{agent} \(2\) will get the good with price \(V_{3}\). Further, we see that the sum of
the values obtained by \hyperref[def:player]{agents} other than \(\tilde{1}\) is \(V_{2}\), since now \hyperref[def:player]{agent} \(2\) gets
the good and his valuation is \(V_{2}\).

We see that by the appearance of \hyperref[def:player]{agent} \(1\), other \hyperref[def:player]{agents} collectively lost \(V_{2}\) values.
We call such collectively lost values as \emph{externality} \hyperref[def:player]{agent} \(1\) imposes.

With this view point to view a second price auction, we see the following principle.
\begin{theorem}[Vickrey-Clarke-Groves principle]\label{thm:VCG}
	Charge a price to an \hyperref[def:player]{agent} as the externality \hyperref[def:player]{agent} imposes on others.
\end{theorem}
\begin{eg}
	We see that for
	\begin{itemize}
		\item \hyperref[def:player]{Agent} \(1\) should be charged with price \(V_2\)
		\item \hyperref[def:player]{Agent} \(2\) should be charged with:
		      \par In the original auction, the value of all other \hyperref[def:player]{agents} are \(V_{1}\). Now, replace \hyperref[def:player]{agent}
		      \(2\) by a dummy \hyperref[def:player]{agent} \(\tilde{2}\), then the value of all \hyperref[def:player]{agents} other
		      than \(\tilde{2}\) is \(V_{1}\). Hence, the difference is
		      \[
			      \Delta_{2} = V_{1} - V_{1} = 0,
		      \]
		      namely by \hyperref[thm:VCG]{VCG principle}, we charge \hyperref[def:player]{agent} \(2\) with price \(0\).
	\end{itemize}
\end{eg}

To apply \hyperref[thm:VCG]{VCG principle} in a matching market problem mathematically, we first denote the total set of sellers as \(S\), and the total
set of buyers as \(B\). Recall the definition of \(V^{\ast}\), we further specify it by adding the superscript and subscript as
\[
	V^{*, S}_{B}
\]
for considering \(S\) and \(B\) in the programming. Then, for \(i\in B\), denote \(j^{\ast} (i)\) as the matched seller respect to \(i\) in a perfect matching that
maximize social welfare. Now, consider the \emph{reduced problem}, namely calculate
\[
	V^{*, S-j^{\ast}(i)}_{B-i},
\]
which stands for the value of everyone else when \hyperref[def:player]{agent} \(i\) is not present.

Lastly, we consider the \underline{alternate problem}, where we need to calculate the value that everyone else gets if \(i\) is not present, namely we
calculate
\[
	V^{*, S}_{\widetilde{B}}
\]
where \(\widetilde{B} \coloneqq B - i + \varnothing \), where \(\varnothing \) stands for a dummy \hyperref[def:player]{agent} \(\widetilde{i} \).

Combining the reduced problem and the alternate problem, together with the \hyperref[thm:VCG]{VCG principle}, we see that the auctioneer should charge buyer \(i\)
\[
	p_{i}^\mathrm{VCG} = V_{\widetilde{B} }^{*, S} - V_{B-i}^{\ast, S-j^{\ast} (i)}.
\]

We now simply let
\[
	p_{j^{\ast} (i)} = p_{i}^\mathrm{VCG},
\]
namely we make the price as \hyperref[rmk:posted]{posted price}.

\begin{remark}
	We finally note that
	\begin{itemize}
		\item It's a \hyperref[note:market-clearing-prices]{market clearing price}, furthermore, it's actually the minimum
		      \hyperref[note:market-clearing-prices]{market clearing price}.
		\item There is a conceptual difference between the \hyperref[thm:VCG]{VCG} approach and the \hyperref[algo:Demange-Gale-Sotomayor-algorithm]{DGS algorithm}
		      approach. One is \hyperref[rmk:posted]{posted}, one is not. We see that in \hyperref[thm:VCG]{VCG} approach, we determine
		      the prices for each \hyperref[def:player]{agent} by their valuation, while this is not the case in
		      \hyperref[algo:Demange-Gale-Sotomayor-algorithm]{DGS algorithm} approach.
	\end{itemize}
\end{remark}